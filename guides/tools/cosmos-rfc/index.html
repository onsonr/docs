
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Sonr is a decentralized identity network built on the Cosmos-sdk. It has early origins as a peer-to-peer file sharing network, but has since evolved into a platform for decentralized authentication and authorization. The early lessons taught from our file sharing roots are used as our theology for building the Sonr Blockchain.">
      
      
      
        <link rel="canonical" href="https://onsonr.dev/guides/tools/cosmos-rfc/">
      
      
        <link rel="prev" href="../cosmos-proto/">
      
      
        <link rel="next" href="../cosmos-sdk/">
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.49">
    
    
      
        <title>RFC 004: Account System Refactor - Sonr Docs</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.6f8fc17f.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Geist:300,300i,400,400i,700,700i%7CGeist+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Geist";--md-code-font:"Geist Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#rfc-004-account-system-refactor" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Sonr Docs" class="md-header__button md-logo" aria-label="Sonr Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Sonr Docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              RFC 004: Account System Refactor
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        
  
    
  
  Introduction

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../changelog/" class="md-tabs__link">
        
  
    
  
  Changelog

      </a>
    </li>
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../Chain-Modules/" class="md-tabs__link">
          
  
    
  
  Guides

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../modules/sonr-did/" class="md-tabs__link">
          
  
    
  
  Modules

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../tools/cosmos-proto/" class="md-tabs__link">
          
  
    
  
  Tools

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Sonr Docs" class="md-nav__button md-logo" aria-label="Sonr Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Sonr Docs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Introduction
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../changelog/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Changelog
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Guides
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Guides
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Chain-Modules/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Chain Modules
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Consumer-Launch/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Consumer Chain Launch Process
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Self-Custody/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Self Custody
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../System-Architecture/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    System Architecture
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Token-Economy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Token Economy
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../nebula-ui/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Nebula ui
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../sdk-usage/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Sdk usage
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../svc-management/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Svc management
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_9" checked>
        
          
          <label class="md-nav__link" for="__nav_3_9" id="__nav_3_9_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Tools
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_9_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3_9">
            <span class="md-nav__icon md-icon"></span>
            Tools
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cosmos-proto/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Protocol Buffers in Cosmos SDK
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    RFC 004: Account System Refactor
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    RFC 004: Account System Refactor
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#status" class="md-nav__link">
    <span class="md-ellipsis">
      Status
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#current-limitations" class="md-nav__link">
    <span class="md-ellipsis">
      Current Limitations
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#proposal" class="md-nav__link">
    <span class="md-ellipsis">
      Proposal
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Proposal">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#rethinking-account-representation-and-business-logic" class="md-nav__link">
    <span class="md-ellipsis">
      Rethinking Account Representation and Business Logic
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#account-message-reception" class="md-nav__link">
    <span class="md-ellipsis">
      Account Message Reception
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#consequences" class="md-nav__link">
    <span class="md-ellipsis">
      Consequences
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Consequences">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#standardization" class="md-nav__link">
    <span class="md-ellipsis">
      Standardization
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implementation" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implementation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#account-definition" class="md-nav__link">
    <span class="md-ellipsis">
      Account Definition
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-internalaccount-definition" class="md-nav__link">
    <span class="md-ellipsis">
      The InternalAccount definition
    </span>
  </a>
  
    <nav class="md-nav" aria-label="The InternalAccount definition">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#init" class="md-nav__link">
    <span class="md-ellipsis">
      Init
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execute" class="md-nav__link">
    <span class="md-ellipsis">
      Execute
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#query" class="md-nav__link">
    <span class="md-ellipsis">
      Query
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#schema" class="md-nav__link">
    <span class="md-ellipsis">
      Schema
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#migrate" class="md-nav__link">
    <span class="md-ellipsis">
      Migrate
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xaccounts-module" class="md-nav__link">
    <span class="md-ellipsis">
      x/accounts module
    </span>
  </a>
  
    <nav class="md-nav" aria-label="x/accounts module">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#msgdeploy" class="md-nav__link">
    <span class="md-ellipsis">
      MsgDeploy
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#address-derivation" class="md-nav__link">
    <span class="md-ellipsis">
      Address derivation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#msgexecute" class="md-nav__link">
    <span class="md-ellipsis">
      MsgExecute
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#msgmigrate" class="md-nav__link">
    <span class="md-ellipsis">
      MsgMigrate
    </span>
  </a>
  
    <nav class="md-nav" aria-label="MsgMigrate">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#authorize-messages" class="md-nav__link">
    <span class="md-ellipsis">
      Authorize Messages
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#further-discussion" class="md-nav__link">
    <span class="md-ellipsis">
      Further discussion
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Further discussion">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sub-accounts" class="md-nav__link">
    <span class="md-ellipsis">
      Sub-accounts
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#predictable-address-creation" class="md-nav__link">
    <span class="md-ellipsis">
      Predictable address creation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#joining-multiple-accounts" class="md-nav__link">
    <span class="md-ellipsis">
      Joining Multiple Accounts
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cosmos-sdk/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Cosmos SDK Core Components
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ibc-accounts/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Interchain Accounts
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ibc-fee-middleware/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ibc-transfer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Modules
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Modules
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../modules/sonr-did/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    x/did
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../modules/sonr-dwn/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    x/dwn
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../modules/sonr-service/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    x/svc
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../modules/sonr-token/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Sonr token
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../modules/ucan-spec/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    User Controlled Authorization Network (UCAN) Specification
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Tools
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Tools
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tools/cosmos-proto/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Protocol Buffers in Cosmos SDK
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tools/cosmos-rfc/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    RFC 004: Account System Refactor
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tools/cosmos-sdk/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Cosmos SDK Core Components
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tools/ibc-accounts/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Interchain Accounts
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tools/ibc-fee-middleware/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tools/ibc-transfer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="rfc-004-account-system-refactor">RFC 004: Account System Refactor</h1>
<h2 id="status">Status</h2>
<ul>
<li>Draft v2 (May 2023)</li>
</ul>
<h2 id="current-limitations">Current Limitations</h2>
<ol>
<li><strong>Account Representation</strong>: Limited by <code>google.Protobuf.Any</code> encapsulation and basic authentication methods</li>
<li><strong>Interface Constraints</strong>: Lacks support for advanced functionalities like vesting and complex auth systems</li>
<li><strong>Implementation Rigidity</strong>: Poor differentiation between account types (e.g., <code>ModuleAccount</code>)</li>
<li><strong>Authorization System</strong>: Basic <code>x/auth</code> module with limited scope beyond <code>x/bank</code> functionality</li>
<li><strong>Dependency Issues</strong>: Cyclic dependencies between modules (e.g., <code>x/auth</code> â†” <code>x/bank</code> for vesting)</li>
</ol>
<h2 id="proposal">Proposal</h2>
<p>This proposal aims to transform the way accounts are managed within the Cosmos SDK by introducing significant changes to
their structure and functionality.</p>
<h3 id="rethinking-account-representation-and-business-logic">Rethinking Account Representation and Business Logic</h3>
<p>Instead of representing accounts as simple <code>google.Protobuf.Any</code> structures stored in state with no business logic
attached, this proposal suggests a more sophisticated account representation that is closer to module entities.
In fact, accounts should be able to receive messages and process them in the same way modules do, and be capable of storing
state in a isolated (prefixed) portion of state belonging only to them, in the same way as modules do.</p>
<h3 id="account-message-reception">Account Message Reception</h3>
<p>We propose that accounts should be able to receive messages in the same way modules can, allowing them to manage their
own state modifications without relying on other modules. This change would enable more advanced account functionality, such as the
<code>VestingAccount</code> example, where the x/bank module previously needed to change the vestingState by casting the abstracted
account to <code>VestingAccount</code> and triggering the <code>TrackDelegation</code> call. Accounts are already capable of sending messages when
a state transition, originating from a transaction, is executed.</p>
<p>When accounts receive messages, they will be able to identify the sender of the message and decide how to process the
state transition, if at all.</p>
<h3 id="consequences">Consequences</h3>
<p>These changes would have significant implications for the Cosmos SDK, resulting in a system of actors that are equal from
the runtime perspective. The runtime would only be responsible for propagating messages between actors and would not
manage the authorization system. Instead, actors would manage their own authorizations. For instance, there would be no
need for the <code>x/auth</code> module to manage minting or burning of coins permissions, as it would fall within the scope of the
<code>x/bank</code> module.</p>
<p>The key difference between accounts and modules would lie in the origin of the message (state transition). Accounts
(ExternallyOwnedAccount), which have credentials (e.g., a public/private key pairing), originate state transitions from
transactions. In contrast, module state transitions do not have authentication credentials backing them and can be
caused by two factors: either as a consequence of a state transition coming from a transaction or triggered by a scheduler
(e.g., the runtime's Begin/EndBlock).</p>
<p>By implementing these proposed changes, the Cosmos SDK will benefit from a more extensible, versatile, and efficient account
management system that is better suited to address the requirements of the Cosmos ecosystem.</p>
<h4 id="standardization">Standardization</h4>
<p>With <code>x/accounts</code> allowing a modular api there becomes a need for standardization of accounts or the interfaces wallets and other clients should expect to use. For this reason we will be using the <a href="https://github.com/cosmos/cips"><code>CIP</code> repo</a> in order to standardize interfaces in order for wallets to know what to expect when interacting with accounts.</p>
<h2 id="implementation">Implementation</h2>
<h3 id="account-definition">Account Definition</h3>
<p>We define the new <code>Account</code> type, which is what an account needs to implement to be treated as such.
An <code>Account</code> type is defined at APP level, so it cannot be dynamically loaded as the chain is running without upgrading the
node code, unless we create something like a <code>CosmWasmAccount</code> which is an account backed by an <code>x/wasm</code> contract.</p>
<pre><code class="language-go">// Account is what the developer implements to define an account.
type Account[InitMsg proto.Message] interface {
    // Init is the function that initialises an account instance of a given kind.
    // InitMsg is used to initialise the initial state of an account.
    Init(ctx *Context, msg InitMsg) error
    // RegisterExecuteHandlers registers an account's execution messages.
    RegisterExecuteHandlers(executeRouter *ExecuteRouter)
    // RegisterQueryHandlers registers an account's query messages.
    RegisterQueryHandlers(queryRouter *QueryRouter)
    // RegisterMigrationHandlers registers an account's migration messages.
    RegisterMigrationHandlers(migrationRouter *MigrationRouter)
}
</code></pre>
<h3 id="the-internalaccount-definition">The InternalAccount definition</h3>
<p>The public <code>Account</code> interface implementation is then converted by the runtime into an <code>InternalAccount</code> implementation,
which contains all the information and business logic needed to operate the account.</p>
<pre><code class="language-go">type Schema struct {
    state StateSchema // represents the state of an account
    init InitSchema // represents the init msg schema
    exec ExecSchema // represents the multiple execution msg schemas, containing also responses
    query QuerySchema // represents the multiple query msg schemas, containing also responses
    migrate *MigrateSchema // represents the multiple migrate msg schemas, containing also responses, it's optional
}

type InternalAccount struct {
    init    func(ctx *Context, msg proto.Message) (*InitResponse, error)
    execute func(ctx *Context, msg proto.Message) (*ExecuteResponse, error)
    query   func(ctx *Context, msg proto.Message) (proto.Message, error)
    schema  func() *Schema
    migrate func(ctx *Context, msg proto.Message) (*MigrateResponse, error)
}
</code></pre>
<p>This is an internal view of the account as intended by the system. It is not meant to be what developers implement. An
example implementation of the <code>InternalAccount</code> type can be found in <a href="https://github.com/testinginprod/accounts-poc/blob/main/examples/recover/recover.go">this</a>
example of account whose credentials can be recovered. In fact, even if the <code>Internal</code> implementation is untyped (with
respect to <code>proto.Message</code>), the concrete implementation is fully typed.</p>
<p>During any of the execution methods of <code>InternalAccount</code>, <code>schema</code> excluded, the account is given a <code>Context</code> which provides:</p>
<ul>
<li>A namespaced <code>KVStore</code> for the account, which isolates the account state from others (NOTE: no <code>store keys</code> needed,
  the account address serves as <code>store key</code>).</li>
<li>Information regarding itself (its address)</li>
<li>Information regarding the sender.</li>
<li>...</li>
</ul>
<h4 id="init">Init</h4>
<p>Init defines the entrypoint that allows for a new account instance of a given kind to be initialised.
The account is passed some opaque protobuf message which is then interpreted and contains the instructions that
constitute the initial state of an account once it is deployed.</p>
<p>An <code>Account</code> code can be deployed multiple times through the <code>Init</code> function, similar to how a <code>CosmWasm</code> contract code
can be deployed (Instantiated) multiple times.</p>
<h4 id="execute">Execute</h4>
<p>Execute defines the entrypoint that allows an <code>Account</code> to process a state transition, the account can decide then how to
process the state transition based on the message provided and the sender of the transition.</p>
<h4 id="query">Query</h4>
<p>Query defines a read-only entrypoint that provides a stable interface that links an account with its state. The reason for
which <code>Query</code> is still being preferred as an addition to raw state reflection is to:</p>
<ul>
<li>Provide a stable interface for querying (state can be optimised and change more frequently than a query)</li>
<li>Provide a way to define an account <code>Interface</code> with respect to its <code>Read/Write</code> paths.</li>
<li>Provide a way to query information that cannot be processed from raw state reflection, ex: compute information from lazy
  state that has not been yet concretely processed (eg: balances with respect to lazy inputs/outputs)</li>
</ul>
<h4 id="schema">Schema</h4>
<p>Schema provides the definition of an account from <code>API</code> perspective, and it's the only thing that should be taken into account
when interacting with an account from another account or module, for example: an account is an <code>authz-interface</code> account if
it has the following message in its execution messages <code>MsgProxyStateTransition{ state_transition: google.Protobuf.Any }</code>.</p>
<h3 id="migrate">Migrate</h3>
<p>Migrate defines the entrypoint that allows an <code>Account</code> to migrate its state from a previous version to a new one. Migrations
can be initiated only by the account itself, concretely this means that the migrate action sender can only be the account address
itself, if the account wants to allow another address to migrate it on its behalf then it could create an execution message
that makes the account migrate itself.</p>
<h3 id="xaccounts-module">x/accounts module</h3>
<p>In order to create accounts we define a new module <code>x/accounts</code>, note that <code>x/accounts</code> deploys account with no authentication
credentials attached to it which means no action of an account can be incepted from a TX, we will later explore how the
<code>x/authn</code> module uses <code>x/accounts</code> to deploy authenticated accounts.</p>
<p>This also has another important implication for which account addresses are now fully decoupled from the authentication mechanism
which makes in turn off-chain operations a little more complex, as the chain becomes the real link between account identifier
and credentials.</p>
<p>We could also introduce a way to deterministically compute the account address.</p>
<p>Note, from the transaction point of view, the <code>init_message</code> and <code>execute_message</code> are opaque <code>google.Protobuf.Any</code>.</p>
<p>The module protobuf definition for <code>x/accounts</code> are the following:</p>
<pre><code class="language-protobuf">// Msg defines the Msg service.
service Msg {
  rpc Deploy(MsgDeploy) returns (MsgDeployResponse);
  rpc Execute(MsgExecute) returns (MsgExecuteResponse);
  rpc Migrate(MsgMigrate) returns (MsgMigrateResponse);
}

message MsgDeploy {
  string sender = 1;
  string kind = 2;
  google.Protobuf.Any init_message = 3;
  repeated google.Protobuf.Any authorize_messages = 4 [(gogoproto.nullable) = false];
}

message MsgDeployResponse {
  string address = 1;
  uint64 id = 2;
  google.Protobuf.Any data = 3;
}

message MsgExecute {
  string sender = 1;
  string address = 2;
  google.Protobuf.Any message = 3;
  repeated google.Protobuf.Any authorize_messages = 4 [(gogoproto.nullable) = false];
}

message MsgExecuteResponse {
  google.Protobuf.Any data = 1;
}

message MsgMigrate {
  string sender = 1;
  string new_account_kind = 2;
  google.Protobuf.Any migrate_message = 3;
}

message MsgMigrateResponse {
  google.Protobuf.Any data = 1;
}

</code></pre>
<h4 id="msgdeploy">MsgDeploy</h4>
<p>Deploys a new instance of the given account <code>kind</code> with initial settings represented by the <code>init_message</code> which is a <code>google.Protobuf.Any</code>.
Of course the <code>init_message</code> can be empty. A response is returned containing the account ID and humanised address, alongside some response
that the account instantiation might produce.</p>
<h4 id="address-derivation">Address derivation</h4>
<p>In order to decouple public keys from account addresses, we introduce a new address derivation mechanism which is</p>
<h4 id="msgexecute">MsgExecute</h4>
<p>Sends a <code>StateTransition</code> execution request, where the state transition is represented by the <code>message</code> which is a <code>google.Protobuf.Any</code>.
The account can then decide if to process it or not based on the <code>sender</code>.</p>
<h3 id="msgmigrate">MsgMigrate</h3>
<p>Migrates an account to a new version of itself, the new version is represented by the <code>new_account_kind</code>. The state transition
can only be incepted by the account itself, which means that the <code>sender</code> must be the account address itself. During the migration
the account current state is given to the new version of the account, which then executes the migration logic using the <code>migrate_message</code>,
it might change state or not, it's up to the account to decide. The response contains possible data that the account might produce
after the migration.</p>
<h4 id="authorize-messages">Authorize Messages</h4>
<p>The <code>Deploy</code> and <code>Execute</code> messages have a field in common called <code>authorize_messages</code>, these messages are messages that the account
can execute on behalf of the sender. For example, in case an account is expecting some funds to be sent from the sender,
the sender can attach a <code>MsgSend</code> that the account can execute on the sender's behalf. These authorizations are short-lived,
they live only for the duration of the <code>Deploy</code> or <code>Execute</code> message execution, or until they are consumed.</p>
<p>An alternative would have been to add a <code>funds</code> field, like it happens in cosmwasm, which guarantees the called contract that
the funds are available and sent in the context of the message execution. This would have been a simpler approach, but it would
have been limited to the context of <code>MsgSend</code> only, where the asset is <code>sdk.Coins</code>. The proposed generic way, instead, allows
the account to execute any message on behalf of the sender, which is more flexible, it could include NFT send execution, or
more complex things like <code>MsgMultiSend</code> or <code>MsgDelegate</code>, etc.</p>
<h3 id="further-discussion">Further discussion</h3>
<h4 id="sub-accounts">Sub-accounts</h4>
<p>We could provide a way to link accounts to other accounts. Maybe during deployment the sender could decide to link the
newly created to its own account, although there might be use-cases for which the deployer is different from the account
that needs to be linked, in this case a handshake protocol on linking would need to be defined.</p>
<h4 id="predictable-address-creation">Predictable address creation</h4>
<p>We need to provide a way to create an account with a predictable address, this might serve a lot of purposes, like accounts
wanting to generate an address that:</p>
<ul>
<li>nobody else can claim besides the account used to generate the new account</li>
<li>is predictable</li>
</ul>
<p>For example:</p>
<pre><code class="language-protobuf">
message MsgDeployPredictable {
  string sender = 1;
  uint32 nonce = 2;
  ...
}
</code></pre>
<p>And then the address becomes <code>bechify(concat(sender, nonce))</code></p>
<p><code>x/accounts</code> would still use the monotonically increasing sequence as account number.</p>
<h4 id="joining-multiple-accounts">Joining Multiple Accounts</h4>
<p>As developers are building new kinds of accounts, it becomes necessary to provide a default way to combine the
functionalities of different account types. This allows developers to avoid duplicating code and enables end-users to
create or migrate to accounts with multiple functionalities without requiring custom development.</p>
<p>To address this need, we propose the inclusion of a default account type called "MultiAccount". The MultiAccount type is
designed to merge the functionalities of other accounts by combining their execution, query, and migration APIs.
The account joining process would only fail in the case of API (intended as non-state Schema APIs) conflicts, ensuring
compatibility and consistency.</p>
<p>With the introduction of the MultiAccount type, users would have the option to either migrate their existing accounts to
a MultiAccount type or extend an existing MultiAccount with newer APIs. This flexibility empowers users to leverage
various account functionalities without compromising compatibility or resorting to manual code duplication.</p>
<p>The MultiAccount type serves as a standardized solution for combining different account functionalities within the
cosmos-sdk ecosystem. By adopting this approach, developers can streamline the development process and users can benefit
from a modular and extensible account system.</p>
<h1 id="adr-071-cryptography-v2-multi-curve-support">ADR 071: Cryptography v2- Multi-curve support</h1>
<h2 id="change-log">Change log</h2>
<ul>
<li>May 7th 2024: Initial Draft (Zondax AG: @raynaudoe @juliantoledano @jleni @educlerici-zondax @lucaslopezf)</li>
<li>June 13th 2024: Add CometBFT implementation proposal (Zondax AG: @raynaudoe @juliantoledano @jleni @educlerici-zondax @lucaslopezf)</li>
<li>July 2nd 2024: Split ADR proposal, add link to ADR in cosmos/crypto (Zondax AG: @raynaudoe @juliantoledano @jleni @educlerici-zondax @lucaslopezf)</li>
</ul>
<h2 id="status_1">Status</h2>
<p>DRAFT</p>
<h2 id="abstract">Abstract</h2>
<p>This ADR proposes the refactoring of the existing <code>Keyring</code> and <code>cosmos-sdk/crypto</code> code to implement <a href="https://github.com/cosmos/crypto/blob/main/docs/architecture/adr-001-crypto-provider.md">ADR-001-CryptoProviders</a>.</p>
<p>For in-depth details of the <code>CryptoProviders</code> and their design please refer to ADR mentioned above.</p>
<h2 id="introduction">Introduction</h2>
<p>The introduction of multi-curve support in the cosmos-sdk cryptographic package offers significant advantages. By not being restricted to a single cryptographic curve, developers can choose the most appropriate curve based on security, performance, and compatibility requirements. This flexibility enhances the application's ability to adapt to evolving security standards and optimizes performance for specific use cases, helping to future-proofing the sdk's cryptographic capabilities.</p>
<p>The enhancements in this proposal not only render the <a href="https://github.com/cosmos/cosmos-sdk/issues/14940">"Keyring ADR"</a> obsolete, but also encompass its key aspects, replacing it with a more flexible and comprehensive approach. Furthermore, the gRPC service proposed in the mentioned ADR can be easily implemented as a specialized <code>CryptoProvider</code>.</p>
<h3 id="glossary">Glossary</h3>
<ol>
<li>
<p><strong>Interface</strong>: In the context of this document, "interface" refers to Go's interface.</p>
</li>
<li>
<p><strong>Module</strong>: In this document, "module" refers to a Go module.</p>
</li>
<li>
<p><strong>Package</strong>: In the context of Go, a "package" refers to a unit of code organization.</p>
</li>
</ol>
<h2 id="context">Context</h2>
<p>In order to fully understand the need for changes and the proposed improvements, it's crucial to consider the current state of affairs:</p>
<ul>
<li>
<p>The Cosmos SDK currently lacks a comprehensive ADR for the cryptographic package.</p>
</li>
<li>
<p>If a blockchain project requires a cryptographic curve that is not supported by the current SDK, the most likely scenario is that they will need to fork the SDK repository and make modifications. These modifications could potentially make the fork incompatible with future updates from the upstream SDK, complicating maintenance and integration.</p>
</li>
<li>
<p>Type leakage of specific crypto data types expose backward compatibility and extensibility challenges.</p>
</li>
<li>
<p>The demand for a more flexible and extensible approach to cryptography and address management is high.</p>
</li>
<li>
<p>Architectural changes are necessary to resolve many of the currently open issues related to new curves support.</p>
</li>
<li>
<p>There is a current trend towards modularity in the Interchain stack (e.g., runtime modules).</p>
</li>
<li>
<p>Security implications are a critical consideration during the redesign work.</p>
</li>
</ul>
<h2 id="objectives">Objectives</h2>
<p>The key objectives for this proposal are:</p>
<ul>
<li>Leverage <code>CryptoProviders</code>: Utilize them as APIs for cryptographic tools, ensuring modularity, flexibility, and ease of integration.</li>
</ul>
<p>Developer-Centric Approach</p>
<ul>
<li>Prioritize clear, intuitive interfaces and best-practice design principles.</li>
</ul>
<p>Quality Assurance</p>
<ul>
<li>Enhanced Test Coverage: Improve testing methodologies to ensure the robustness and reliability of the module.</li>
</ul>
<h2 id="technical-goals">Technical Goals</h2>
<p>New Keyring:</p>
<ul>
<li>Design a new <code>Keyring</code> interface with modular backends injection system to support hardware devices and cloud-based HSMs. This feature is optional and tied to complexity; if it proves too complex, it will be deferred to a future release as an enhancement.</li>
</ul>
<h2 id="proposed-architecture">Proposed architecture</h2>
<h3 id="components">Components</h3>
<p>The main components to be used will be the same as those found in the <a href="https://github.com/cosmos/crypto/blob/main/docs/architecture/adr-001-crypto-provider.md#components">ADR-001</a>.</p>
<h4 id="storage-and-persistence">Storage and persistence</h4>
<p>The storage and persistence layer is tasked with storing a <code>CryptoProvider</code>s. Specifically, this layer must:</p>
<ul>
<li>Securely store the crypto provider's associated private key (only if stored locally, otherwise a reference to the private key will be stored instead).</li>
<li>Store the <a href="https://github.com/cosmos/crypto/blob/main/docs/architecture/adr-001-crypto-provider.md#metadata"><code>ProviderMetadata</code></a> struct which contains the data that distinguishes that provider.</li>
</ul>
<p>The purpose of this layer is to ensure that upon retrieval of the persisted data, we can access the provider's type, version, and specific configuration (which varies based on the provider type). This information will subsequently be utilized to initialize the appropriate factory, as detailed in the following section on the factory pattern.</p>
<p>The storage proposal involves using a modified version of the <a href="https://github.com/cosmos/cosmos-sdk/blob/main/proto/cosmos/crypto/keyring/v1/record.proto">Record</a> struct, which is already defined in <strong>Keyring/v1</strong>. Additionally, we propose utilizing the existing keyring backends (keychain, filesystem, memory, etc.) to store these <code>Record</code>s in the same manner as the current <strong>Keyring/v1</strong>.</p>
<p><em>Note: This approach will facilitate a smoother migration path from the current Keyring/v1 to the proposed architecture.</em></p>
<p>Below is the proposed protobuf message to be included in the modified <code>Record.proto</code> file</p>
<h5 id="protobuf-message-structure">Protobuf message structure</h5>
<p>The <a href="https://github.com/cosmos/cosmos-sdk/blob/main/proto/cosmos/crypto/keyring/v1/record.proto">record.proto</a> file will be modified to include the <code>CryptoProvider</code> message as an optional field as follows.</p>
<pre><code class="language-protobuf">
// record.proto

message Record {
  string name = 1;
  google.protobuf.Any pub_key = 2;

  oneof item {
    Local local = 3;
    Ledger ledger = 4;
    Multi multi = 5;
    Offline offline = 6;
    CryptoProvider crypto_provider = 7; // &lt;- New
  }

  message Local {
    google.protobuf.Any priv_key = 1;
  }

  message Ledger {
    hd.v1.BIP44Params path = 1;
  }

  message Multi {}

  message Offline {}
}
</code></pre>
<h5 id="creating-and-loading-a-cryptoprovider">Creating and loading a <code>CryptoProvider</code></h5>
<p>For creating providers, we propose a <em>factory pattern</em> and a <em>registry</em> for these builders. Examples of these
patterns can be found <a href="https://github.com/cosmos/crypto/blob/main/docs/architecture/adr-001-crypto-provider.md#illustrative-code-snippets">here</a></p>
<h5 id="keyring">Keyring</h5>
<p>The new <code>Keyring</code> interface will serve as a central hub for managing and fetching <code>CryptoProviders</code>. To ensure a smoother migration path, the new Keyring will be backward compatible with the previous version. Since this will be the main API from which applications will obtain their <code>CryptoProvider</code> instances, the proposal is to extend the Keyring interface to include the methods:</p>
<pre><code class="language-go">type KeyringV2 interface {
  // methods from Keyring/v1

  // ListCryptoProviders returns a list of all the stored CryptoProvider metadata.
  ListCryptoProviders() ([]ProviderMetadata, error)

  // GetCryptoProvider retrieves a specific CryptoProvider by its id.
  GetCryptoProvider(id string) (CryptoProvider, error)
}
</code></pre>
<p><em>Note</em>: Methods to obtain a provider from a public key or other means that make it easier to load the desired provider can be added.</p>
<h5 id="especial-use-case-remote-signers">Especial use case: remote signers</h5>
<p>It's important to note that the <code>CryptoProvider</code> interface is versatile enough to be implemented as a remote signer. This capability allows for the integration of remote cryptographic operations, which can be particularly useful in distributed or cloud-based environments where local cryptographic resources are limited or need to be managed centrally.</p>
<h2 id="alternatives">Alternatives</h2>
<p>It is important to note that all the code presented in this document is not in its final form and could be subject to changes at the time of implementation. The examples and implementations discussed should be interpreted as alternatives, providing a conceptual framework rather than definitive solutions. This flexibility allows for adjustments based on further insights, technical evaluations, or changing requirements as development progresses.</p>
<h2 id="decision">Decision</h2>
<p>We will:</p>
<ul>
<li>Leverage crypto providers</li>
<li>Refactor the module structure as described above.</li>
<li>Define types and interfaces as the code attached.</li>
<li>Refactor existing code into new structure and interfaces.</li>
<li>Implement Unit Tests to ensure no backward compatibility issues.</li>
</ul>
<h2 id="consequences_1">Consequences</h2>
<h3 id="impact-on-the-sdk-codebase">Impact on the SDK codebase</h3>
<p>We can divide the impact of this ADR into two main categories: state machine code and client related code.</p>
<h4 id="client">Client</h4>
<p>The major impact will be on the client side, where the current <code>Keyring</code> interface will be replaced by the new <code>KeyringV2</code> interface. At first, the impact will be low since <code>CryptoProvider</code> is an optional field in the <code>Record</code> message, so there's no mandatory requirement for migrating to this new concept right away. This allows a progressive transition where the risks of breaking changes or regressions are minimized.</p>
<h4 id="state-machine">State Machine</h4>
<p>The impact on the state machine code will be minimal, the modules affected (at the time of writing this ADR)
are the <code>x/accounts</code> module, specifically the <code>Authenticate</code> function and the <code>x/auth/ante</code> module. This function will need to be adapted to use a <code>CryptoProvider</code> service to make use of the <code>Verifier</code> instance.</p>
<p>Worth mentioning that there's also the alternative of using <code>Verifier</code> instances in a standalone fashion (see note below).</p>
<p>The specific way to adapt these modules will be deeply analyzed and decided at implementation time of this ADR.</p>
<p><em>Note</em>: All cryptographic tools (hashers, verifiers, signers, etc.) will continue to be available as standalone packages that can be imported and utilized directly without the need for a <code>CryptoProvider</code> instance. However, the <code>CryptoProvider</code> is the recommended method for using these tools as it offers a more secure way to handle sensitive data, enhanced modularity, and the ability to store configurations and metadata within the <code>CryptoProvider</code> definition.</p>
<h3 id="backwards-compatibility">Backwards Compatibility</h3>
<p>The proposed migration path is similar to what the cosmos-sdk has done in the past. To ensure a smooth transition, the following steps will be taken:</p>
<p>Once ADR-001 is implemented with a stable release:</p>
<ul>
<li>Deprecate the old crypto package. The old crypto package will still be usable, but it will be marked as deprecated and users can opt to use the new package.</li>
<li>Migrate the codebase to use the new cosmos/crypto package and remove the old crypto one.</li>
</ul>
<h3 id="positive">Positive</h3>
<ul>
<li>Single place of truth</li>
<li>Easier to use interfaces</li>
<li>Easier to extend</li>
<li>Unit test for each crypto package</li>
<li>Greater maintainability</li>
<li>Incentivize addition of implementations instead of forks</li>
<li>Decoupling behavior from implementation</li>
<li>Sanitization of code</li>
</ul>
<h3 id="negative">Negative</h3>
<ul>
<li>It will involve an effort to adapt existing code.</li>
<li>It will require attention to detail and audition.</li>
</ul>
<h3 id="neutral">Neutral</h3>
<ul>
<li>It will involve extensive testing.</li>
</ul>
<h2 id="test-cases">Test Cases</h2>
<ul>
<li>The code will be unit tested to ensure a high code coverage</li>
<li>There should be integration tests around Keyring and CryptoProviders.</li>
</ul>
<blockquote>
<p>While an ADR is in the DRAFT or PROPOSED stage, this section should contain a
summary of issues to be solved in future iterations (usually referencing comments
from a pull-request discussion).</p>
<p>Later, this section can optionally list ideas or improvements the author or
reviewers found during the analysis of this ADR.</p>
</blockquote>
<h1 id="adr-71-bank-v2">ADR-71 Bank V2</h1>
<h2 id="status_2">Status</h2>
<p>DRAFT</p>
<h2 id="changelog">Changelog</h2>
<ul>
<li>2024-05-08: Initial Draft (@samricotta, @julienrbrt)</li>
</ul>
<h2 id="abstract_1">Abstract</h2>
<p>The primary objective of refactoring the bank module is to simplify and enhance the functionality of the Cosmos SDK. Over time the bank module has been burdened with numerous responsibilities including transaction handling, account restrictions, delegation counting, and the minting and burning of coins.</p>
<p>In addition to the above, the bank module is currently too rigid and handles too many tasks, so this proposal aims to streamline the module by focusing on core functions <code>Send</code>, <code>Mint</code>, and <code>Burn</code>.</p>
<p>Currently, the module is split across different keepers with scattered and duplicates functionalities (with 4 send functions for instance).</p>
<p>Additionally, the integration of the token factory into the bank module allows for standardization, and better integration within the core modules.</p>
<p>This rewrite will reduce complexity and enhance the efficiency and UX of the bank module.</p>
<h2 id="context_1">Context</h2>
<p>The current implementation of the bank module is characterised by its handling of a broad array of functions, leading to significant complexity in using and extending the bank module.</p>
<p>These issues have underscored the need for a refactoring strategy that simplifies the moduleâ€™s architecture and focuses on its most essential operations.</p>
<p>Additionally, there is an overlap in functionality with a Token Factory module, which could be integrated to streamline oper.</p>
<h2 id="decision_1">Decision</h2>
<p><strong>Permission Tightening</strong>: Access to the module can be restricted to selected denominations only, ensuring that it operates within designated boundaries and does not exceed its intended scope. Currently, the permissions allow all denoms, so this should be changed. Send restrictions functionality will be maintained.</p>
<p><strong>Simplification of Logic</strong>: The bank module will focus on core functionalities <code>Send</code>, <code>Mint</code>, and <code>Burn</code>. This refinement aims to streamline the architecture, enhancing both maintainability and performance.</p>
<p><strong>Integration of Token Factory</strong>: The Token Factory will be merged into the bank module. This consolidation of related functionalities aims to reduce redundancy and enhance coherence within the system. Migrations functions will be provided for migrating from Osmosis' Token Factory module to bank/v2.</p>
<p><strong>Legacy Support</strong>: A legacy wrapper will be implemented to ensure compatibility with about 90% of existing functions. This measure will facilitate a smooth transition while keeping older systems functional.</p>
<p><strong>Denom Implementation</strong>: A asset interface will be added to standardise interactions such as transfers, balance inquiries, minting, and burning across different tokens. This will allow the bank module to support arbitrary asset types, enabling developers to implement custom, ERC20-like denominations.</p>
<p>For example, currently if a team would like to extend the transfer method the changes would apply universally, affecting all denomâ€™s. With the proposed Asset Interface, it allows teams to customise or extend the transfer method specifically for their own tokens without impacting others.</p>
<p>These improvements are expected to enhance the flexibility of the bank module, allowing for the creation of custom tokens similar to ERC20 standards and assets backed by CosmWasm (CW) contracts. The integration efforts will also aim to unify CW20 with bank coins across the Cosmos chains.</p>
<p>Example of denom interface:</p>
<pre><code class="language-go">type AssetInterface interface {
    Transfer(ctx sdk.Context, from sdk.AccAddress, to sdk.AccAddress, amount sdk.Coin) error
    Mint(ctx sdk.Context, to sdk.AccAddress, amount sdk.Coin) error
    Burn(ctx sdk.Context, from sdk.AccAddress, amount sdk.Coin) error
    QueryBalance(ctx sdk.Context, account sdk.AccAddress) (sdk.Coin, error)
}
</code></pre>
<p>Overview of flow:</p>
<ol>
<li>Alice initiates a transfer by entering Bob's address and the amount (100 ATOM)</li>
<li>The Bank module verifies that the ATOM token implements the <code>AssetInterface</code> by querying the <code>ATOM_Denom_Account</code>, which is an <code>x/account</code> denom account.</li>
<li>The Bank module executes the transfer by subtracting 100 ATOM from Aliceâ€™s balance and adding 100 ATOM to Bobâ€™s balance.</li>
<li>The Bank module calls the Transfer method on the <code>ATOM_Denom_Account</code>. The Transfer method, defined in the <code>AssetInterface</code>, handles the logic to subtract 100 ATOM from Aliceâ€™s balance and add 100 ATOM to Bobâ€™s balance.</li>
<li>The Bank module updates the chain and returns the new balances.</li>
<li>Both Alice and Bob successfully receive the updated balances.</li>
</ol>
<h2 id="migration-plans">Migration Plans</h2>
<p>Bank is a widely used module, so getting a v2 needs to be thought thoroughly. In order to not force all dependencies to immediately migrate to bank/v2, the same <em>upgrading</em> path will be taken as for the <code>gov</code> module.</p>
<p>This means <code>cosmossdk.io/bank</code> will stay one module and there won't be a new <code>cosmossdk.io/bank/v2</code> go module. Instead the bank protos will be versioned from <code>v1beta1</code> (current bank) to <code>v2</code>.</p>
<p>Bank <code>v1beta1</code> endpoints will use the new bank v2 implementation for maximum backward compatibility.</p>
<p>The bank <code>v1beta1</code> keepers will be deprecated and potentially eventually removed, but its proto and messages definitions will remain.</p>
<p>Additionally, as bank plans to integrate token factory, migrations functions will be provided to migrate from Osmosis token factory implementation (most widely used implementation) to the new bank/v2 token factory.</p>
<h2 id="consequences_2">Consequences</h2>
<h3 id="positive_1">Positive</h3>
<ul>
<li>Simplified interaction with bank APIs</li>
<li>Backward compatible changes (no contracts or apis broken)</li>
<li>Optional migration (note: bank <code>v1beta1</code> won't get any new feature after bank <code>v2</code> release)</li>
</ul>
<h3 id="neutral_1">Neutral</h3>
<ul>
<li>Asset implementation not available cross-chain (IBC-ed custom asset should possibly fallback to the default implementation)</li>
<li>Many assets may slow down bank balances requests</li>
</ul>
<h3 id="negative_1">Negative</h3>
<ul>
<li>Temporarily duplicate functionalities as bank <code>v1beta1</code> are <code>v2</code> are living alongside</li>
<li>Difficultity to ever completely remove bank <code>v1beta1</code></li>
</ul>
<h3 id="references">References</h3>
<ul>
<li>Current bank module implementation: https://github.com/cosmos/cosmos-sdk/blob/v0.50.6/x/bank/keeper/keeper.go#L22-L53</li>
<li>Osmosis token factory: https://github.com/osmosis-labs/osmosis/tree/v25.0.0/x/tokenfactory/keeper</li>
</ul>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../cosmos-proto/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Protocol Buffers in Cosmos SDK">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Protocol Buffers in Cosmos SDK
              </div>
            </div>
          </a>
        
        
          
          <a href="../cosmos-sdk/" class="md-footer__link md-footer__link--next" aria-label="Next: Cosmos SDK Core Components">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                Cosmos SDK Core Components
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["announce.dismiss", "content.action.edit", "content.action.view", "content.code.annotate", "content.code.copy", "content.code.select", "content.tooltips", "navigation.footer", "navigation.indexes", "navigation.instant", "navigation.sections", "navigation.tabs", "navigation.tabs.sticky", "navigation.top", "navigation.tracking", "search.highlight", "search.share", "search.suggest", "toc.follow", "toc.integrate"], "search": "../../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.88dd0f4e.min.js"></script>
      
    
  </body>
</html>